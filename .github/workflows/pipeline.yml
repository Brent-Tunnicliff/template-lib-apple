# Copyright Â© 2025 Brent Tunnicliff <brent@tunnicliff.dev>

name: Pipeline

on:
  push:
  workflow_dispatch:

env:
  DEMO_SCHEME: "Demo"
  DEMO_WATCH_SCHEME: "Demo Watch App"
  PACKAGE_SCHEME: "REPLACE_ME"

jobs:
  test:
    runs-on: macos-15
    strategy:
      # Don't fail the other matrix values if one fails.
      fail-fast: false
      matrix:
        target: [
          { platform: "iOS", simulator_version: "18" },
          { platform: "tvOS", simulator_version: "18" },
          { platform: "watchOS", simulator_version: "11" },
          { platform: "visionOS", simulator_version: "2" },

          # macOS runs on the host and doesn't need a simulator.
          { platform: "macOS", simulator_version: "" }
        ]
    steps:
      # ---------------------------
      # Setup
      # ---------------------------

      # List all environment variables to help with debugging possible issues.
      - name: List environment variables
        run: set

      # If this matrix target runs on simulator, then list all simulators to help with debugging possible issues.
      - name: List installed simulators
        if: ${{ matrix.target.simulator_version != '' }}
        run: xcrun simctl list devices

      - name: Configure destination for target
        id: destination
        uses: Brent-Tunnicliff/action-xcodebuild-destination-apple@v1
        with:
          platform: "${{ matrix.target.platform }}"
          simulator_version: "${{ matrix.target.simulator_version }}"

      - uses: actions/checkout@v4

      - name: Set Xcode version
        run: sudo xcode-select -s "/Applications/Xcode_16.4.app"

      - name: Configure test results path
        id: test_results_config
        run: |
          # We cannot use : in the time, otherwise `actions/upload-artifact` fails.
          TIMESTAMP=$(date -u +%Y-%m-%dT%H%M%SZ)
          TARGET_COMPONENT="${{ matrix.target.platform }}${{ matrix.target.simulator_version }}"
          FILE_NAME="test-$PACKAGE_SCHEME-$TARGET_COMPONENT-$TIMESTAMP.xcresult"
          echo "file_name: $FILE_NAME"
          echo "file_name=$FILE_NAME" >> "$GITHUB_OUTPUT"

          PATH="$GITHUB_WORKSPACE/build/test/$FILE_NAME"
          echo "path: $PATH"
          echo "path=$PATH" >> "$GITHUB_OUTPUT"

      # ---------------------------
      # Build and test package
      # ---------------------------

      - name: Build package debug
        run: xcodebuild build
          -scheme "$PACKAGE_SCHEME"
          -destination "${{ steps.destination.outputs.destination }}"
          -configuration "Debug"
          -skipPackagePluginValidation
          CODE_SIGN_IDENTITY=""
          CODE_SIGNING_REQUIRED=NO

      - name: Build package tests
        run: xcodebuild build-for-testing
          -scheme "$PACKAGE_SCHEME"
          -destination "${{ steps.destination.outputs.destination }}"
          -skipPackagePluginValidation
          CODE_SIGN_IDENTITY=""
          CODE_SIGNING_REQUIRED=NO

      - name: Run package tests
        run: xcodebuild test-without-building
          -scheme "$PACKAGE_SCHEME"
          -destination "${{ steps.destination.outputs.destination }}"
          -resultBundlePath "${{ steps.test_results_config.outputs.path }}"
          CODE_SIGN_IDENTITY=""
          CODE_SIGNING_REQUIRED=NO

      - name: Upload test results
        if: success() || failure()
        uses: actions/upload-artifact@v4
        with:
          name: "${{ steps.test_results_config.outputs.file_name }}"
          path: "${{ steps.test_results_config.outputs.path }}"
          if-no-files-found: error

      # Lets make sure it also builds in release configuration in case there are conditionals.
      - name: Build package release
        run: xcodebuild build
          -scheme "$PACKAGE_SCHEME"
          -destination "${{ steps.destination.outputs.destination }}"
          -configuration "Release"
          -skipPackagePluginValidation
          CODE_SIGN_IDENTITY=""
          CODE_SIGNING_REQUIRED=NO

      # ---------------------------
      # Build demo
      # ---------------------------

      - name: Configure demo scheme
        id: demo_scheme
        run: |
          if [[ "${{ matrix.target.platform }}" == "watchOS" ]]; then
            SCHEME="$DEMO_WATCH_SCHEME"
          else
            SCHEME="$DEMO_SCHEME"
          fi

          if [[ $SCHEME == "" ]]; then
            echo "SCHEME missing"
            exit 1
          fi

          echo $SCHEME
          echo "scheme=$SCHEME" >> "$GITHUB_OUTPUT"

      # We don't release demo, so only build the debug configuration.
      - name: Build demo
        working-directory: ./Demo
        run: xcodebuild build
            -project "Demo.xcodeproj"
            -scheme "${{ steps.demo_scheme.outputs.scheme }}"
            -destination "${{ steps.destination.outputs.destination }}"
            -configuration "Debug"
            -skipPackagePluginValidation
            CODE_SIGN_IDENTITY=""
            CODE_SIGNING_REQUIRED=NO

      # ---------------------------
      # Final checks
      # ---------------------------

      # Make sure there are no local changes as any auto generated changes must be checked into git.
      - name: Check git status
        uses: Brent-Tunnicliff/action-git-status@v1
